(function () { var overlay = $('<div id="galleryOverlay">'), slider = $('<div id="gallerySlider">'), prevArrow = $('<a id="prevArrow"></a>'), nextArrow = $('<a id="nextArrow"></a>'), overlayVisible = false; $.fn.touchTouch = function () { var placeholders = $([]), index = 0, allitems = this, items = allitems; overlay.hide().appendTo("body"); slider.appendTo(overlay); items.each(function () { placeholders = placeholders.add($('<div class="placeholder">')) }); slider.append(placeholders).on("click", function (e) { hideOverlay() }); slider.touchCount = 0; slider.prevMoveX = 0; $("body").on("touchstart", "#gallerySlider img", function (e) { var touchs = e.originalEvent || e.touchs, startX = e.changedTouches[0].pageX; slider.on("touchmove", function (e) { e.preventDefault(); var touch = e.touches[0] || e.changedTouches[0]; if (touch.pageX - startX > 10) { slider.off("touchmove"); showPrevious() } else { if (touch.pageX - startX < -10) { slider.off("touchmove"); showNext() } } slider.thisMoveX = touch.pageX - startX }); return false }).on("touchend", function () { if (slider.prevMoveX == slider.thisMoveX) { hideOverlay() } else { slider.prevMoveX = slider.thisMoveX; slider.off("touchmove") } }); items.on("click", function (e) { e.preventDefault(); var $this = $(this), galleryName, selectorType, $closestGallery = $this.parent().closest("[data-gallery]"); if ($this.attr("data-gallery")) { galleryName = $this.attr("data-gallery"); selectorType = "item" } else { if ($closestGallery.length) { galleryName = $closestGallery.attr("data-gallery"); selectorType = "ancestor" } } if (galleryName && selectorType == "item") { items = $("[data-gallery=" + galleryName + "]") } else { if (galleryName && selectorType == "ancestor") { items = items.filter(function () { return $(this).parent().closest("[data-gallery]").length }) } } index = items.index(this); showOverlay(index); showImage(index); preload(index + 1); preload(index - 1) }); if (!("ontouchstart" in window)) { overlay.append(prevArrow).append(nextArrow); prevArrow.click(function (e) { e.preventDefault(); showPrevious() }); nextArrow.click(function (e) { e.preventDefault(); showNext() }) } $(window).bind("keydown", function (e) { if (e.keyCode == 37) { showPrevious() } else { if (e.keyCode == 39) { showNext() } else { if (e.keyCode == 27) { hideOverlay() } } } }); function showOverlay(index) { if (overlayVisible) { return false } overlay.show(); setTimeout(function () { overlay.addClass("visible") }, 100); offsetSlider(index); overlayVisible = true } function hideOverlay() { if (!overlayVisible) { return false } overlay.hide().removeClass("visible"); overlayVisible = false; $(".placeholder").empty(); items = allitems } function offsetSlider(index) { slider.css("left", (-index * 100) + "%") } function preload(index) { setTimeout(function () { showImage(index) }, 1000) } function showImage(index) { if (index < 0 || index >= items.length) { return false } loadImage(items.eq(index).data("src"), function () { placeholders.eq(index).html(this) }) } function loadImage(src, callback) { var img = $("<img>").on("load", function () { callback.call(img) }); img.attr("src", src) } function showNext() { if (index + 1 < items.length) { index++; offsetSlider(index); preload(index + 1) } else { slider.addClass("rightSpring"); setTimeout(function () { slider.removeClass("rightSpring") }, 500) } } function showPrevious() { if (index > 0) { index--; offsetSlider(index); preload(index - 1) } else { slider.addClass("leftSpring"); setTimeout(function () { slider.removeClass("leftSpring") }, 500) } } } })(Zepto);