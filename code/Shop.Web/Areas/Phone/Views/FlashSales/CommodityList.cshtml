@using Shop.Model
@{
    var flashSales = ViewBag.FalshSales as FlashSales;
    ViewBag.Title = flashSales ==null? "药品列表":flashSales.FlashSales_Name;
    Layout = "~/Areas/Phone/Views/Shared/_Layout.cshtml";
}

<header class="tc header">

            <a href='@Url.RouteUrl("Phone_FlashSales_Index")' class="goback"></a>
            <h2>@(flashSales == null ? "药品列表" : flashSales.FlashSales_Name)</h2>

</header>
<input id="tag-id" type="hidden" value="@ViewBag.FalshSalesId" />
<div class="main pro">
    <div class="order dis-flex tc">
        <a onclick="searchData(this)" class="on tag-price up"><span>价格</span><i class="fa fa-long-arrow-down"></i></a>
        <a onclick="searchData(this)" class="tag-discount"><span>折扣</span><i class="fa fa-long-arrow-down"></i></a>
        <a onclick="searchData(this)" class="tag-sales"><span>销量</span><i class="fa fa-long-arrow-down"></i></a>
    </div>
    <div class="rows">
        <dl class="pro-wrapper clearfix commodity-list"></dl>
    </div>
</div>
@section Js
    {
    <script type="text/javascript">
    var para = {};
    para.pageNum = 1, para.numPerPage = 20, para.sortName = '', para.sortOrder = '', para.search = '';
    var loadCommodityList = function (para, isloadMore) {
        $.ajax({
            url: "/Phone/FlashSales/CommodityItemList",
            data: para,
            success: function (data) {
                if (isloadMore) {
                    if (data) {//有数据
                        //加载更多 就追加
                        $('.loadmoreDiv').remove();
                        $('.commodity-list').append(data).show(500);
                    } else {//没有数据
                        $('.loadmoreDiv').remove();
                        $('.commodity-list').append('<div class="tc loadmoreDiv"><a href="javascript:void(0);" class="btn loadmore">已加载全部数据</a></div>');
                        setTimeout(function () {
                            $('.loadmoreDiv').hide();
                        }, 1500);

                    }


                } else { //搜索或者第一次加载
                    if (data) {
                        //搜索
                        $('.commodity-list').html(data).show(500);
                    } else {
                        window.location.href = "/PhoneError?title=" + escape("未找到") + "&msg=" + escape("暂时未找到药品");
                    }

                }

            }
        });
    }

    var defaultTagId = parseInt($('#tag-id').val());
    para.salesId = defaultTagId || 0;
    para.sortName = 'Commodity_CostPrice';
    para.sortOrder = 'Desc';
    $(function () {
        loadCommodityList(para);
    });

    var searchData = function (self, isLoadMore) {
        if (self) {
            var $self = $(self);

            //确定排序规则
            if (!isLoadMore) {//切换排序字段 和排序规则
                para.pageNum = 1;
                if ($self.hasClass('on')) {
                    if ($self.hasClass('up')) {
                        $self.removeClass('up').addClass('down');
                        para.sortOrder = 'Desc';
                    } else {
                        $self.removeClass('down').addClass('up');
                        para.sortOrder = 'Asc';
                    }
                } else {
                    $self.addClass('on').addClass('up').siblings().removeClass('on').removeClass('up').addClass('down');
                    para.sortOrder = 'Asc';
                }
            } else { //加载更多
                if ($self.hasClass('up')) {
                    para.sortOrder = 'Asc';
                } else {
                    para.sortOrder = 'Desc';
                }
            }

            //确定排序字段
            if ($self.hasClass('tag-price')) {
                para.sortName = 'Commodity_CostPrice';
            } else if ($self.hasClass('tag-discount')) {
                para.sortName = 'Realtion_Discount';
            } else if ($self.hasClass('tag-sales')) {
                para.sortName = 'Commodity_Sales';
            }

            loadCommodityList(para, isLoadMore);

        }
    }

    var loadMore = function () {
        var self = $('.order').find('.on');
        para.pageNum += 1;
        searchData(self, true);
    }

</script>

}